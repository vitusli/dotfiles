#!/bin/bash

# Deploy application configurations to OS-specific paths
# This script runs after chezmoi apply

SHARED_DIR="{{ .chezmoi.sourceDir }}/shared"

# ==========================
# VSCode
# ==========================
VSCODE_SOURCE="$SHARED_DIR/vscode"

{{- if eq .chezmoi.os "darwin" }}
VSCODE_TARGET="$HOME/Library/Application Support/Code/User"
{{- end }}

{{- if eq .chezmoi.os "windows" }}
VSCODE_TARGET="$APPDATA/Code/User"
{{- end }}

{{- if eq .chezmoi.os "linux" }}
VSCODE_TARGET="$HOME/.config/Code/User"
{{- end }}

mkdir -p "$VSCODE_TARGET"

chezmoi execute-template < "$VSCODE_SOURCE/settings.json.tmpl" > "$VSCODE_TARGET/settings.json"
chezmoi execute-template < "$VSCODE_SOURCE/keybindings.json.tmpl" > "$VSCODE_TARGET/keybindings.json"

cp "$VSCODE_SOURCE/custom-vscode.css" "$VSCODE_TARGET/custom-vscode.css"

echo "VSCode config deployed to $VSCODE_TARGET"

# ==========================
# Zed
# ==========================
ZED_SOURCE="$SHARED_DIR/zed"

{{- if eq .chezmoi.os "darwin" }}
ZED_TARGET="$HOME/.config/zed"
{{- end }}

{{- if eq .chezmoi.os "windows" }}
ZED_TARGET="$APPDATA/Zed"
{{- end }}

{{- if eq .chezmoi.os "linux" }}
ZED_TARGET="$HOME/.config/zed"
{{- end }}

mkdir -p "$ZED_TARGET"

chezmoi execute-template < "$ZED_SOURCE/keymap.json.tmpl" > "$ZED_TARGET/keymap.json"
cp "$ZED_SOURCE/private_settings.json" "$ZED_TARGET/settings.json"

echo "Zed config deployed to $ZED_TARGET"

# ==========================
# Neovim
# ==========================
NVIM_SOURCE="$SHARED_DIR/nvim"

{{- if eq .chezmoi.os "darwin" }}
NVIM_TARGET="$HOME/.config/nvim"
{{- else if eq .chezmoi.os "linux" }}
NVIM_TARGET="$HOME/.config/nvim"
{{- else if eq .chezmoi.os "windows" }}
NVIM_TARGET="$LOCALAPPDATA/nvim"
{{- end }}

mkdir -p "$NVIM_TARGET"

chezmoi execute-template < "$NVIM_SOURCE/init.vim.tmpl" > "$NVIM_TARGET/init.vim"

echo "Neovim config deployed to $NVIM_TARGET"

# ==========================
# lf File Manager
# ==========================
LF_SOURCE="$SHARED_DIR/lf"

{{- if eq .chezmoi.os "darwin" }}
LF_TARGET="$HOME/.config/lf"
{{- else if eq .chezmoi.os "linux" }}
LF_TARGET="$HOME/.config/lf"
{{- else if eq .chezmoi.os "windows" }}
LF_TARGET="$APPDATA/lf"
{{- end }}

mkdir -p "$LF_TARGET"

chezmoi execute-template < "$LF_SOURCE/lfrc.tmpl" > "$LF_TARGET/lfrc"

{{- if eq .chezmoi.os "windows" }}
cp "$LF_SOURCE/preview.cmd" "$LF_TARGET/preview.cmd"
{{- else }}
cp "$LF_SOURCE/preview.sh" "$LF_TARGET/preview.sh"
cp "$LF_SOURCE/cleaner.sh" "$LF_TARGET/cleaner.sh"
chmod +x "$LF_TARGET/preview.sh" "$LF_TARGET/cleaner.sh"
{{- end }}

echo "lf config deployed to $LF_TARGET"

# ==========================
# Zen Browser (macOS only)
# ==========================
{{- if eq .chezmoi.os "darwin" }}
ZEN_POLICIES_SOURCE="$SHARED_DIR/zen/policies.json"
ZEN_POLICIES_TARGET="/Applications/Zen Browser.app/Contents/Resources/distribution"

if [ -f "$ZEN_POLICIES_SOURCE" ] && [ -d "/Applications/Zen Browser.app" ]; then
    mkdir -p "$ZEN_POLICIES_TARGET"
    cp "$ZEN_POLICIES_SOURCE" "$ZEN_POLICIES_TARGET/policies.json"
    echo "Zen Browser policies deployed to $ZEN_POLICIES_TARGET"

    # Restart Zen Browser if running to apply policies
    if pgrep -f "Zen Browser" > /dev/null; then
        pkill -9 -f "Zen Browser"
        sleep 1
        open -a "Zen Browser"
        echo "Zen Browser restarted to apply policies"
    fi
else
    echo "Zen Browser or policies not found, skipping..."
fi
{{- end }}
