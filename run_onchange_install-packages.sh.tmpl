#!/bin/bash

# =============================================================================
# Homebrew Package Installation (idempotent)
# This script is run by chezmoi to install required packages.
# Reads from bootstrap/config/cli.txt and bootstrap/config/gui.txt
#
# Config hashes (chezmoi re-runs this script when these change):
# cli.txt hash: {{ include "bootstrap/config/cli.txt" | sha256sum }}
# gui.txt hash: {{ include "bootstrap/config/gui.txt" | sha256sum }}
# =============================================================================

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
CONFIG_DIR="$SCRIPT_DIR/bootstrap/config"
CHEZMOI_DIR="$SCRIPT_DIR"

# =============================================================================
# Detect platform
# =============================================================================
case "$(uname -s)" in
    Darwin) PLATFORM="macos" ;;
    Linux)  PLATFORM="linux" ;;
    MINGW*|MSYS*|CYGWIN*) PLATFORM="windows" ;;
    *) echo "Unknown platform"; exit 1 ;;
esac

echo "Detected platform: $PLATFORM"

# =============================================================================
# Parse config file - extract packages for current platform
# Usage: parse_packages "cli.txt"
# Returns packages that have no tag OR have the current platform tag
# =============================================================================
parse_packages() {
    local file="$CONFIG_DIR/$1"

    if [[ ! -f "$file" ]]; then
        echo "Config file not found: $file" >&2
        return 1
    fi

    while IFS= read -r line || [[ -n "$line" ]]; do
        # Skip empty lines and comments
        [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]] && continue

        # Extract package name (before any #tag)
        local pkg=$(echo "$line" | sed 's/[[:space:]]*#.*//')
        [[ -z "$pkg" ]] && continue

        # Check platform tags
        if [[ "$line" =~ \# ]]; then
            # Has tags - check if our platform is included
            if echo "$line" | grep -q "#${PLATFORM}"; then
                echo "$pkg"
            fi
            # If has tags but not our platform, skip
        else
            # No tags = all platforms
            echo "$pkg"
        fi
    done < "$file"
}

# =============================================================================
# Check if a package has a matching file/directory in the chezmoi directory
# Matches package name against file/directory names (partial match)
# e.g. "karabiner-elements" matches "karabiner", "aerospace" matches "dot_aerospace.toml"
# Usage: has_config_match "package-name"
# Returns 0 if match found, 1 otherwise
# =============================================================================
has_config_match() {
    local pkg="$1"

    [[ ! -d "$CHEZMOI_DIR" ]] && return 1

    # Search all files and directories recursively
    while IFS= read -r path; do
        local name=$(basename "$path")
        # Check if package name contains the name or vice versa
        if [[ "$pkg" == *"$name"* ]] || [[ "$name" == *"$pkg"* ]]; then
            return 0
        fi
    done < <(find "$CHEZMOI_DIR" -mindepth 1 \( -name "bootstrap" -prune \) -o \( -type f -o -type d \) -print 2>/dev/null)
    return 1
}

# =============================================================================
# Filter packages - only return packages that have matching config directories
# Usage: filter_packages_with_config "cli.txt"
# =============================================================================
filter_packages_with_config() {
    local file="$1"
    while IFS= read -r pkg; do
        [[ -z "$pkg" ]] && continue
        if has_config_match "$pkg"; then
            echo "$pkg"
        fi
    done <<< "$(parse_packages "$file")"
}

# =============================================================================
# macOS: Homebrew installation
# =============================================================================
install_macos() {
    # Check if Homebrew is installed
    if ! command -v brew &>/dev/null; then
        echo "Installing Homebrew..."
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        eval "$(/opt/homebrew/bin/brew shellenv)"
    fi

    echo "Installing Homebrew packages..."

    # Install CLI tools (formulae) - only those with matching configs
    echo "=== Installing CLI tools with matching configs (formulae) ==="
    local cli_with_config=$(filter_packages_with_config cli.txt)
    if [[ -n "$cli_with_config" ]]; then
        while IFS= read -r formula; do
            [[ -z "$formula" ]] && continue
            if ! brew list --formula "$formula" &>/dev/null 2>&1; then
                echo "  Installing $formula..."
                brew install "$formula" || echo "  Failed to install $formula"
            else
                echo "  ✓ $formula"
            fi
        done <<< "$cli_with_config"
    else
        echo "  No CLI packages with matching configs found."
    fi

    # Install GUI apps (casks) - only those with matching configs
    echo "=== Installing GUI apps with matching configs (casks) ==="
    local gui_with_config=$(filter_packages_with_config gui.txt)
    if [[ -n "$gui_with_config" ]]; then
        while IFS= read -r cask; do
            [[ -z "$cask" ]] && continue
            if ! brew list --cask "$cask" &>/dev/null 2>&1; then
                echo "  Installing $cask..."
                brew install --cask "$cask" || echo "  Failed to install $cask"
            else
                echo "  ✓ $cask"
            fi
        done <<< "$gui_with_config"
    else
        echo "  No GUI packages with matching configs found."
    fi

    echo "Homebrew package installation complete!"
}

# =============================================================================
# Linux: Package installation (pacman/yay for Arch)
# =============================================================================
install_linux() {
    echo "Linux package installation not yet implemented in chezmoi."
    echo "Use bootstrap/linux.sh for full setup."
}

# =============================================================================
# Windows: Scoop installation
# =============================================================================
install_windows() {
    echo "Windows package installation not yet implemented in chezmoi."
    echo "Use bootstrap/windows.ps1 for full setup."
}

# =============================================================================
# Main
# =============================================================================
case "$PLATFORM" in
    macos)   install_macos ;;
    linux)   install_linux ;;
    windows) install_windows ;;
esac
