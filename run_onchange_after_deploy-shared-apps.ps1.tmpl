{{- if eq .chezmoi.os "windows" }}
# =============================================================================
# Deploy shared application configs to OS-specific paths
# This script runs when .chezmoidata.yaml changes
#
# Configuration is driven by .chezmoidata.yaml - edit paths there, not here!
#
# .chezmoidata.yaml hash: {{ include ".chezmoidata.yaml" | sha256sum }}
# =============================================================================

$ErrorActionPreference = "Stop"

$SHARED_DIR = "{{ .chezmoi.sourceDir }}"
$OS = "windows"

Write-Host "Deploying shared app configs for $OS..."

# =============================================================================
# Generic app deployment from .chezmoidata.yaml
# =============================================================================

{{- range $app, $config := .shared_apps }}
{{- $target := index $config.target "windows" }}
{{- if $target }}

# ==========================
# {{ $app }}
# ==========================
$TARGET = "$env:USERPROFILE\{{ $target | replace "/" "\\" }}"
$SOURCE = "$SHARED_DIR\{{ $config.source | replace "/" "\\" }}"

New-Item -ItemType Directory -Force -Path $TARGET | Out-Null

# Common files (all platforms)
{{- range $config.files }}
{{- if .template }}
Get-Content "$SOURCE\{{ .src }}" -Raw | chezmoi execute-template | Out-File -FilePath "$TARGET\{{ .dst }}" -Encoding utf8
{{- else }}
Copy-Item "$SOURCE\{{ .src }}" -Destination "$TARGET\{{ .dst }}" -Force
{{- end }}
{{- end }}

# OS-specific files (Windows)
{{- range (index $config "files_windows") }}
Copy-Item "$SOURCE\{{ .src }}" -Destination "$TARGET\{{ .dst }}" -Force
{{- end }}

Write-Host "  ✓ {{ $app }} → $TARGET"

{{- end }}
{{- end }}

# =============================================================================
# Special apps (non-standard deployment paths)
# =============================================================================

# Zen Browser (Windows) - deploys to application directory
$ZEN_POLICIES_SOURCE = "$SHARED_DIR\{{ .special_apps.zen.source | replace "/" "\\" }}\policies.json"
$ZEN_APP_PATH = "$env:LOCALAPPDATA\Programs\Zen Browser"
$ZEN_POLICIES_TARGET = "$ZEN_APP_PATH\distribution"

if ((Test-Path $ZEN_POLICIES_SOURCE) -and (Test-Path $ZEN_APP_PATH))
{
    New-Item -ItemType Directory -Force -Path $ZEN_POLICIES_TARGET | Out-Null
    Copy-Item $ZEN_POLICIES_SOURCE -Destination "$ZEN_POLICIES_TARGET\policies.json" -Force
    Write-Host "  ✓ zen → $ZEN_POLICIES_TARGET"

    # Restart Zen Browser if running to apply policies
    $zenProcess = Get-Process -Name "zen" -ErrorAction SilentlyContinue
    if ($zenProcess)
    {
        Stop-Process -Name "zen" -Force
        Start-Sleep -Seconds 1
        Start-Process "$ZEN_APP_PATH\zen.exe"
        Write-Host "    (Zen Browser restarted)"
    }
} else
{
    Write-Host "  ⊘ zen (not installed, skipping)"
}

Write-Host "Shared app deployment complete!"
{{- end }}
