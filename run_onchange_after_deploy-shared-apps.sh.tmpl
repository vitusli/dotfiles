#!/bin/bash

# =============================================================================
# Deploy shared application configs to OS-specific paths
# This script runs when .chezmoidata.yaml changes
#
# Configuration is driven by .chezmoidata.yaml - edit paths there, not here!
#
# .chezmoidata.yaml hash: {{ include ".chezmoidata.yaml" | sha256sum }}
# =============================================================================

set -e

SHARED_DIR="{{ .chezmoi.sourceDir }}"
OS="{{ .chezmoi.os }}"

echo "Deploying shared app configs for $OS..."

# =============================================================================
# Generic app deployment from .chezmoidata.yaml
# =============================================================================

{{- range $app, $config := .shared_apps }}
{{- $target := index $config.target $.chezmoi.os }}
{{- if $target }}

# ==========================
# {{ $app }}
# ==========================
TARGET="$HOME/{{ $target }}"
SOURCE="$SHARED_DIR/{{ $config.source }}"

mkdir -p "$TARGET"

# Common files (all platforms)
{{- range $config.files }}
{{- if .template }}
chezmoi execute-template < "$SOURCE/{{ .src }}" > "$TARGET/{{ .dst }}"
{{- else }}
cp "$SOURCE/{{ .src }}" "$TARGET/{{ .dst }}"
{{- end }}
{{- end }}

# OS-specific files
{{- if eq $.chezmoi.os "darwin" }}
{{- range (index $config "files_darwin") }}
cp "$SOURCE/{{ .src }}" "$TARGET/{{ .dst }}"
{{- if .executable }}
chmod +x "$TARGET/{{ .dst }}"
{{- end }}
{{- end }}
{{- else if eq $.chezmoi.os "linux" }}
{{- range (index $config "files_linux") }}
cp "$SOURCE/{{ .src }}" "$TARGET/{{ .dst }}"
{{- if .executable }}
chmod +x "$TARGET/{{ .dst }}"
{{- end }}
{{- end }}
{{- end }}

echo "  ✓ {{ $app }} → $TARGET"

{{- end }}
{{- end }}

# =============================================================================
# Special apps (non-standard deployment paths)
# =============================================================================

{{- if eq .chezmoi.os "darwin" }}
# Zen Browser (macOS) - deploys to application bundle
ZEN_POLICIES_SOURCE="$SHARED_DIR/{{ .special_apps.zen.source }}/policies.json"
ZEN_POLICIES_TARGET="{{ .special_apps.zen.target.darwin }}"

if [ -f "$ZEN_POLICIES_SOURCE" ] && [ -d "/Applications/Zen Browser.app" ]; then
    sudo mkdir -p "$ZEN_POLICIES_TARGET"
    sudo cp "$ZEN_POLICIES_SOURCE" "$ZEN_POLICIES_TARGET/policies.json"
    echo "  ✓ zen → $ZEN_POLICIES_TARGET"

    # Restart Zen Browser if running to apply policies
    if pgrep -f "Zen Browser" > /dev/null; then
        pkill -9 -f "Zen Browser"
        sleep 1
        open -a "Zen Browser"
        echo "    (Zen Browser restarted)"
    fi
else
    echo "  ⊘ zen (not installed, skipping)"
fi
{{- end }}

echo "Shared app deployment complete!"
